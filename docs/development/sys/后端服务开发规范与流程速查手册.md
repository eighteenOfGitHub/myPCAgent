### **åç«¯æœåŠ¡å¼€å‘è§„èŒƒä¸æµç¨‹é€ŸæŸ¥æ‰‹å†Œ**

**ğŸ§  æ ¸å¿ƒæ€æƒ³**

1.  **åˆ†å±‚æ¶æ„**: å°†ä»£ç é€»è¾‘æ¸…æ™°åœ°åˆ†ç¦»åˆ°ä¸åŒçš„å±‚ä¸­,å®ç°å…³æ³¨ç‚¹åˆ†ç¦»ã€‚
2.  **åç«¯å‡½æ•°å®ç°ä¸ API åˆ†ç¦»**: ä¸šåŠ¡é€»è¾‘ä¸æ¥å£å®šä¹‰è§£è€¦,æé«˜å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œå¯é‡ç”¨æ€§ã€‚
3.  **å“åº”ä½“æ¨¡å‹æŒ‰ç«¯ç‚¹æ‹†åˆ†**: å°†å…±äº«æ¨¡å‹æŒ‰ API ç«¯ç‚¹æ¨¡å—åŒ–ç»„ç»‡,é¿å…å•ä¸€æ–‡ä»¶è¿‡åº¦è†¨èƒ€ã€‚
4.  **éµå¾ªé¡¹ç›®è§„èŒƒ**: ä¸¥æ ¼éµå®ˆ `AIç¼–ç¨‹è§„èŒƒ.md` ä¸­çš„ Python ç¼–å†™æ ‡å‡†ã€‚

**ğŸ§± é¡¹ç›®ç»“æ„**

```text
Project Root/
â”œâ”€â”€ .gitignore                 # Git å¿½ç•¥è§„åˆ™æ–‡ä»¶
â”œâ”€â”€ requirements.txt          # é¡¹ç›®ä¾èµ–åº“åˆ—è¡¨
â”œâ”€â”€ README.md                 # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ start_script.*            # å¯åŠ¨è„šæœ¬ (ä¾‹å¦‚ start.bat, start.sh)
â”œâ”€â”€ config_files/             # å­˜æ”¾å„ç±»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ environment_config.*  # ç¯å¢ƒå˜é‡é…ç½® (YAML, JSON, .env ç­‰)
â”‚   â””â”€â”€ ...                   # å…¶ä»–é…ç½®æ–‡ä»¶ (æ—¥å¿—ã€æ•°æ®åº“ç­‰)
â”œâ”€â”€ documentation/            # é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ development/          # å¼€å‘ç›¸å…³æ–‡æ¡£
â”‚   â”‚   â””â”€â”€ ...               # å¦‚å¼€å‘è§„èŒƒã€API æ–‡æ¡£ç­‰
â”‚   â””â”€â”€ notes/                # å¼€å‘ç¬”è®°
â”‚       â”œâ”€â”€ errors/           # é”™è¯¯è®°å½•ä¸è§£å†³æ–¹æ¡ˆ
â”‚       â””â”€â”€ systematic/       # ç³»ç»Ÿæ€§ç¬”è®°
â”œâ”€â”€ source_code/              # æºä»£ç ä¸»ç›®å½•
â”‚   â”œâ”€â”€ main.py              # åº”ç”¨å…¥å£æ–‡ä»¶ (FastAPI/Flask/Django main)
â”‚   â”œâ”€â”€ api/                 # API ç›¸å…³ä»£ç 
â”‚   â”‚   â”œâ”€â”€ endpoints/       # API è·¯ç”±å®šä¹‰ (è§†å›¾å‡½æ•°)
â”‚   â”‚   â””â”€â”€ router.py        # API è·¯ç”±èšåˆå™¨
â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸åŸºç¡€é…ç½®
â”‚   â”‚   â”œâ”€â”€ config/          # é¡¹ç›®æ ¸å¿ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ utils/           # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ database.py      # æ•°æ®åº“è¿æ¥ä¸åˆå§‹åŒ–
â”‚   â”‚   â””â”€â”€ logger.py        # æ—¥å¿—ç³»ç»Ÿé…ç½®
â”‚   â”œâ”€â”€ data/                # æ•°æ®æ–‡ä»¶ (å¦‚ SQLite æ•°æ®åº“)
â”‚   â”œâ”€â”€ db_models/           # æ•°æ®åº“æ¨¡å‹å®šä¹‰ (ORM)
â”‚   â”œâ”€â”€ logs/                # æ—¥å¿—æ–‡ä»¶è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ middleware/          # ä¸­é—´ä»¶å®šä¹‰ (å¦‚è®¤è¯ã€æ—¥å¿—è®°å½•)
â”‚   â”œâ”€â”€ migrations/          # æ•°æ®åº“è¿ç§»è„šæœ¬ (å¦‚ Alembic)
â”‚   â””â”€â”€ services/            # ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
â”œâ”€â”€ frontend/                 # å‰ç«¯ä»£ç ç›®å½• (å¦‚æœå‰åç«¯åˆ†ç¦»)
â”‚   â”œâ”€â”€ app.py              # å‰ç«¯åº”ç”¨å…¥å£ (å¦‚ Gradio)
â”‚   â”œâ”€â”€ handlers/           # å‰ç«¯äº‹ä»¶å¤„ç†é€»è¾‘
â”‚   â””â”€â”€ ui/                 # ç”¨æˆ·ç•Œé¢å®šä¹‰
â”‚       â””â”€â”€ pages/          # é¡µé¢å¸ƒå±€
â”œâ”€â”€ shared/                   # å‰åç«¯å…±äº«ä»£ç  (å¦‚æ•°æ®æ¨¡å‹ã€é€šç”¨å‡½æ•°)
â”‚   â””â”€â”€ schemas.py          # æ•°æ®ä¼ è¾“å¯¹è±¡ (DTO) / Pydantic æ¨¡å‹
â””â”€â”€ tests/                    # æµ‹è¯•ä»£ç  (å¯é€‰)
    â””â”€â”€ ...
```

**ğŸ› ï¸ å¼€å‘æµç¨‹**

**1. è®¾è®¡ä¸šåŠ¡é€»è¾‘ (Service Layer):**

*   **ä½ç½®**: `backend/services/service_name.py` (ä¾‹å¦‚ `backend/services/user_service.py`)
*   **åŸåˆ™**:
    *   ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘æœ¬èº«ï¼Œä¸ FastAPI æ¡†æ¶æ— å…³ã€‚
    *   å‡½æ•°å‚æ•°å’Œè¿”å›å€¼ä½¿ç”¨ç®€å•çš„ Python ç±»å‹æˆ– Pydantic æ¨¡å‹å®ä¾‹ã€‚
    *   ä½¿ç”¨ `async def` å®šä¹‰å¼‚æ­¥å‡½æ•°ï¼ˆå¦‚æœæ¶‰åŠ I/O æ“ä½œï¼‰ã€‚
    *   ç¼–å†™æ¸…æ™°çš„å‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸² (Docstring)ã€‚
    *   éµå¾ª `AIç¼–ç¨‹è§„èŒƒ` (å‘½åã€ç±»å‹æç¤ºã€é”™è¯¯å¤„ç†ç­‰)ã€‚
*   **ç¤ºä¾‹ (User Service)**:
    ```python
    # backend/services/user_service.py

    from typing import Dict, Any, List, Optional
    from backend.db_models.user import User as UserDBModel # å¼•å…¥æ•°æ®åº“æ¨¡å‹
    from sqlmodel import Session, select # å‡è®¾ä½¿ç”¨ SQLModel

    class UserService:
        def __init__(self, session: Session):
            self.session = session # ä¾èµ–æ³¨å…¥ Session

        def get_user_by_id(self, user_id: int) -> Optional[UserDBModel]:
            """
            æ ¹æ® ID è·å–ç”¨æˆ·ã€‚

            Args:
                user_id (int): ç”¨æˆ· IDã€‚

            Returns:
                Optional[UserDBModel]: ç”¨æˆ·æ•°æ®åº“æ¨¡å‹å®ä¾‹ï¼Œæœªæ‰¾åˆ°åˆ™è¿”å› Noneã€‚
            """
            statement = select(UserDBModel).where(UserDBModel.id == user_id)
            return self.session.exec(statement).first()

        def create_user(self, username: str, email: str) -> UserDBModel:
            """
            åˆ›å»ºæ–°ç”¨æˆ·ã€‚

            Args:
                username (str): ç”¨æˆ·åã€‚
                email (str): é‚®ç®±ã€‚

            Returns:
                UserDBModel: ä¿å­˜åˆ°æ•°æ®åº“çš„ç”¨æˆ·å®ä¾‹ã€‚
            """
            # ... å®ç°åˆ›å»ºå’Œä¿å­˜é€»è¾‘ ...
            new_user = UserDBModel(username=username, email=email)
            self.session.add(new_user)
            self.session.commit()
            self.session.refresh(new_user) # è·å–æ•°æ®åº“ç”Ÿæˆçš„ ID ç­‰
            return new_user

        # ... å…¶ä»–æ–¹æ³•å¦‚ get_all_users, update_user, delete_user ...
    ```
    *   **æ³¨æ„**: Service ç±»é€šå¸¸ä¼šæ¥æ”¶æ•°æ®åº“ Session æˆ–å…¶ä»–ä¾èµ–é¡¹ä½œä¸ºæ„é€ å‡½æ•°å‚æ•°ï¼Œå®ç°ä¾èµ–æ³¨å…¥ã€‚ä¸šåŠ¡é€»è¾‘å±‚ç›´æ¥æ“ä½œæ•°æ®åº“æ¨¡å‹ (`UserDBModel`)ã€‚

**2. å®šä¹‰å…±äº«æ¨¡å‹ (Schemas):**

*   **ä½ç½®**: `shared/` ç›®å½•ä¸‹,**æŒ‰ API ç«¯ç‚¹æ¨¡å—æ‹†åˆ†**
    *   **æ‹†åˆ†è§„åˆ™**: æ¯ä¸ª API ç«¯ç‚¹æ–‡ä»¶ (`backend/api/endpoints/xxx.py`) å¯¹åº”ä¸€ä¸ªå…±äº«æ¨¡å‹æ–‡ä»¶ (`shared/xxx.py`)
    *   **ç¤ºä¾‹æ˜ å°„**:
        *   `backend/api/endpoints/user.py` â†’ `shared/user.py`
        *   `backend/api/endpoints/chat.py` â†’ `shared/chat.py`
        *   `backend/api/endpoints/llm_setting.py` â†’ `shared/llm_setting.py`
    *   **é€šç”¨æ¨¡å‹**: å¤šä¸ªç«¯ç‚¹å…±ç”¨çš„æ¨¡å‹ï¼ˆå¦‚ `MessageResponse`, `ErrorResponse`ï¼‰ä¿ç•™åœ¨ `shared/schemas.py`

*   **åŸåˆ™**:
    *   **åªå®šä¹‰ç”¨äº API äº¤äº’çš„è¯·æ±‚ä½“å’Œå“åº”ä½“æ¨¡å‹**ã€‚
    *   **ä¸å¾—åœ¨ API ç«¯ç‚¹ä¸­ç›´æ¥ä½¿ç”¨æ•°æ®åº“æ¨¡å‹ (`backend/db_models` ä¸­çš„æ¨¡å‹) è¿›è¡Œæ ¡éªŒæˆ–åºåˆ—åŒ–**ã€‚API ç«¯ç‚¹å¿…é¡»ä½¿ç”¨ `shared/` ä¸­å®šä¹‰çš„æ¨¡å‹ã€‚
    *   ä½¿ç”¨ `pydantic.BaseModel` å®šä¹‰è¯·æ±‚ä½“ã€å“åº”ä½“ã€‚
    *   ä¸º API ç«¯ç‚¹æä¾›æ•°æ®æ ¡éªŒå’Œåºåˆ—åŒ–ã€‚
    *   å“åº”æ¨¡å‹é€šå¸¸ä¸åŒ…å«æ•æ„Ÿå­—æ®µï¼ˆå¦‚å¯†ç å“ˆå¸Œ),æˆ–ä½¿ç”¨ `Field(exclude=True)` æ’é™¤ã€‚
    *   **æšä¸¾ç±»å‹**: å¦‚æœè¯·æ±‚ä½“åŒ…å«æšä¸¾å­—æ®µ,å¿…é¡»åœ¨å¯¹åº”çš„ `shared/xxx.py` æ–‡ä»¶ä¸­å®šä¹‰æšä¸¾ç±»ã€‚

*   **ç¤ºä¾‹ (User Schemas - æ‹†åˆ†å)**:
    ```python
    # shared/user_schemas.py  # å¯¹åº” backend/api/endpoints/user_api.py

    from pydantic import BaseModel, Field
    from typing import Optional
    from datetime import datetime

    # --- è¯·æ±‚ä½“æ¨¡å‹ (ç”¨äºåˆ›å»º/æ›´æ–°) ---
    class UserCreate(BaseModel):
        username: str = Field(..., min_length=3, max_length=50, description="ç”¨æˆ·å")
        email: str = Field(..., regex=r'^[\w\.-]+@[\w\.-]+\.\w+$', description="é‚®ç®±åœ°å€")
        password: str = Field(..., min_length=8, description="å¯†ç ")

    class UserUpdate(BaseModel):
        username: Optional[str] = Field(None, min_length=3, max_length=50, description="ç”¨æˆ·å")
        email: Optional[str] = Field(None, regex=r'^[\w\.-]+@[\w\.-]+\.\w+$', description="é‚®ç®±åœ°å€")

    # --- å“åº”ä½“æ¨¡å‹ (ç”¨äºè¿”å›ç»™å®¢æˆ·ç«¯) ---
    class UserResponse(BaseModel):
        id: int
        username: str
        email: str
        created_at: datetime
        # æ³¨æ„ï¼šä¸åŒ…å« 'password' ç­‰æ•æ„Ÿä¿¡æ¯

        class Config:
            from_attributes = True  # å…è®¸ä» ORM å¯¹è±¡åˆ›å»º
    ```

    ```python
    # shared/llm_setting_schemas.py  # å¯¹åº” backend/api/endpoints/llm_setting_api.py

    from datetime import datetime
    from typing import Optional
    from pydantic import BaseModel
    from enum import Enum

    # --- æšä¸¾å®šä¹‰ ---
    class LLMProvider(str, Enum):
        OPENAI = "OpenAI"
        OLLAMA = "Ollama"

    # --- è¯·æ±‚ä½“æ¨¡å‹ ---
    class LLMConfigCreate(BaseModel):
        provider: LLMProvider
        model_name: str
        api_key: str
        base_url: Optional[str] = None

    # --- å“åº”ä½“æ¨¡å‹ ---
    class LLMConfigResponse(BaseModel):
        id: int
        provider: LLMProvider
        model_name: str
        base_url: Optional[str]
        created_at: datetime
        updated_at: datetime

        class Config:
            from_attributes = True

    class LLMTestResponse(BaseModel):
        success: bool
        message: Optional[str] = None
    ```

    ```python
    # shared/general_schemas.py  # é€šç”¨å“åº”æ¨¡å‹

    from pydantic import BaseModel

    class MessageResponse(BaseModel):
        """é€šç”¨æ¶ˆæ¯å“åº”ï¼ˆç”¨äºåˆ é™¤ã€æ›´æ–°ç­‰æ“ä½œï¼‰"""
        message: str

    class HealthResponse(BaseModel):
        """å¥åº·æ£€æŸ¥å“åº”"""
        status: str
        service: str
        database: str

    class ErrorResponse(BaseModel):
        """é”™è¯¯å“åº”ï¼ˆFastAPI ä¼šè‡ªåŠ¨å¤„ç†,æ­¤å¤„ç”¨äºæ–‡æ¡£ï¼‰"""
        detail: str

    __all__ = ["MessageResponse", "HealthResponse", "ErrorResponse"]
    ```
    *   **æ³¨æ„**: `UserResponse` ä¸åŒ…å« `password` å­—æ®µï¼Œç¡®ä¿æ•æ„Ÿä¿¡æ¯ä¸è¢«æš´éœ²ã€‚`from_attributes=True` å¯¹äºä» ORM æ¨¡å‹ï¼ˆå¦‚ SQLModelï¼‰å®ä¾‹åˆ›å»º Pydantic å“åº”æ¨¡å‹éå¸¸æœ‰ç”¨ã€‚

**3. åˆ›å»º API ç«¯ç‚¹ (Endpoint Layer):**

*   **ä½ç½®**: `backend/api/endpoints/module_name.py` (ä¾‹å¦‚ `backend/api/endpoints/user.py`)
*   **åŸåˆ™**:
    *   ä½¿ç”¨ `fastapi.APIRouter` å®šä¹‰è·¯ç”±ã€‚
    *   **è´Ÿè´£æ•°æ®æ ¡éªŒ**ï¼šä½¿ç”¨ `shared/module_name.py` ä¸­å®šä¹‰çš„**è¯·æ±‚ä½“æ¨¡å‹**ã€‚
    *   **è´Ÿè´£è¿”å›å“åº”**ï¼šä½¿ç”¨ `shared/module_name.py` ä¸­å®šä¹‰çš„**å“åº”ä½“æ¨¡å‹**ã€‚
    *   è´Ÿè´£è°ƒç”¨æœåŠ¡å±‚å‡½æ•°ã€å¤„ç†å¼‚å¸¸ã€‚
    *   ä½¿ç”¨ `response_model` æŒ‡å®šå“åº”æ ¼å¼ï¼ˆå¿…é¡»æ˜¯ `shared/` ä¸­çš„æ¨¡å‹ï¼‰ã€‚
    *   éµå¾ª `AIç¼–ç¨‹è§„èŒƒ`ã€‚
*   **ç¤ºä¾‹ (LLM Setting Endpoints - ä½¿ç”¨æ‹†åˆ†åçš„æ¨¡å‹)**:
    ```python
    # backend/api/endpoints/llm_setting_api.py

    from fastapi import APIRouter, HTTPException
    from typing import List
    from backend.services.llm_setting_service import LLMSettingService
    from shared.llm_setting_schemas import (
        LLMConfigCreate,
        LLMConfigResponse,
        LLMTestResponse
    )

    router = APIRouter(prefix="/settings/llm", tags=["llm-setting"])

    @router.post("", response_model=LLMConfigResponse)
    def create_llm_config(config_data: LLMConfigCreate):
        """åˆ›å»º LLM é…ç½®"""
        service = LLMSettingService()
        try:
            # è°ƒç”¨æœåŠ¡å±‚,æœåŠ¡å±‚å†…éƒ¨ä½¿ç”¨æ•°æ®åº“æ¨¡å‹
            saved_config = service.create(
                provider=config_data.provider.value,  # æšä¸¾è½¬å­—ç¬¦ä¸²
                model_name=config_data.model_name,
                api_key_input=config_data.api_key,
                base_url=config_data.base_url
            )
            # è¿”å›æ•°æ®åº“æ¨¡å‹,FastAPI è‡ªåŠ¨è½¬ä¸º LLMConfigResponse
            return saved_config
        except ValueError as e:
            raise HTTPException(status_code=400, detail=str(e))
        except Exception as e:
            raise HTTPException(status_code=500, detail=f"åˆ›å»ºå¤±è´¥: {str(e)}")

    @router.post("/{config_id}/test", response_model=LLMTestResponse)
    def test_existing_config(config_id: int):
        """æµ‹è¯•å·²å­˜åœ¨çš„ LLM é…ç½®"""
        service = LLMSettingService()
        try:
            config = service.get_by_id(config_id)
            if not config:
                raise HTTPException(status_code=404, detail="é…ç½®ä¸å­˜åœ¨")
            
            test_result = service.test_connection(
                provider=config.provider,
                model_name=config.model_name,
                api_key_input=config.api_key,
                base_url=config.base_url
            )
            
            if test_result["success"]:
                return {"success": True, "message": test_result["message"]}
            else:
                raise HTTPException(status_code=400, detail=test_result["message"])
        except HTTPException:
            raise
        except Exception as e:
            raise HTTPException(status_code=500, detail=f"æµ‹è¯•å¤±è´¥: {str(e)}")

    @router.get("", response_model=List[LLMConfigResponse])
    def list_llm_configs():
        """åˆ—å‡ºæ‰€æœ‰ LLM é…ç½®"""
        service = LLMSettingService()
        try:
            configs = service.get_all()  # è¿”å› DB æ¨¡å‹åˆ—è¡¨
            return configs  # FastAPI åŸºäº from_attributes è½¬ä¸º LLMConfigResponse
        except Exception as e:
            raise HTTPException(status_code=500, detail=f"è·å–åˆ—è¡¨å¤±è´¥: {str(e)}")
    ```
    *   **æ³¨æ„**: API ç«¯ç‚¹å±‚è´Ÿè´£è°ƒç”¨æœåŠ¡å±‚ (`UserService`) çš„æ–¹æ³•ã€‚å®ƒæ¥æ”¶ `shared.schemas.UserCreate` è¿›è¡Œè¯·æ±‚ä½“æ ¡éªŒï¼Œå¹¶ä½¿ç”¨ `shared.schemas.UserResponse` ä½œä¸ºè¿”å›ç±»å‹ã€‚æœåŠ¡å±‚å†…éƒ¨æ“ä½œæ•°æ®åº“æ¨¡å‹ï¼ŒAPI å±‚è´Ÿè´£å°†æ•°æ®åº“æ¨¡å‹è½¬æ¢ä¸ºå…±äº«çš„å“åº”æ¨¡å‹ï¼ˆåˆ©ç”¨ `from_attributes=True`ï¼‰ã€‚

**4. èšåˆ API è·¯ç”± (API Router):**

*   **ä½ç½®**: `backend/api/api_router.py`
*   **åŸåˆ™**:
    *   åˆ›å»ºä¸» `APIRouter` å®ä¾‹ (é€šå¸¸ä¸è®¾ç½® `prefix`)ã€‚
    *   ä½¿ç”¨ `include_router` å°†å„åŠŸèƒ½æ¨¡å—çš„è·¯ç”±å™¨èšåˆè¿›æ¥ã€‚
*   **ç¤ºä¾‹**:
    ```python
    # backend/api/api_router.py

    from fastapi import APIRouter
    from backend.api.endpoints import user # å¯¼å…¥ç«¯ç‚¹è·¯ç”±å™¨

    api_router = APIRouter(tags=["api"])
    api_router.include_router(user.router) # åŒ…å«ç«¯ç‚¹è·¯ç”±
    # api_router.include_router(product.router) # åŒ…å«å…¶ä»–æ¨¡å—è·¯ç”±

    ```
    *   **æ³¨æ„**: è¿™é‡Œæ²¡æœ‰ç»™ `user.router` æ·»åŠ é¢å¤–å‰ç¼€ï¼Œæ‰€ä»¥ç”¨æˆ·ç›¸å…³çš„ API è·¯å¾„å°±æ˜¯ `/api/users/...`ã€‚

**5. å¯åŠ¨ FastAPI åº”ç”¨ (Main):**

*   **ä½ç½®**: `backend/main.py`
*   **åŸåˆ™**:
    *   åˆ›å»º `FastAPI` å®ä¾‹ã€‚
    *   æ·»åŠ ä¸­é—´ä»¶ï¼ˆå¦‚ `CORSMiddleware`ï¼‰ã€‚
    *   ä½¿ç”¨ `app.include_router(api_router, prefix="/api")` åŠ è½½ API è·¯ç”±ã€‚
    *   é€šè¿‡ `uvicorn` å¯åŠ¨åº”ç”¨ã€‚
*   **ç¤ºä¾‹**:
    ```python
    # backend/main.py

    from fastapi import FastAPI
    from fastapi.middleware.cors import CORSMiddleware
    from backend.api.api_router import api_router
    from backend.config.settings import settings

    app = FastAPI(title="My App API")

    app.add_middleware(
        CORSMiddleware,
        allow_origins=settings.ALLOWED_ORIGINS,
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )

    app.include_router(api_router, prefix="/api") # åŠ è½½è·¯ç”±

    if __name__ == "__main__":
        import uvicorn
        uvicorn.run(app, host="127.0.0.1", port=8000)

    ```
    *   **æ³¨æ„**: æœ€ç»ˆçš„ API è·¯å¾„ä¼šæ˜¯ `/api/users/...`ã€‚

**å…³é”®è¦ç‚¹**

1.  **åˆ†ç¦»**: ä¸šåŠ¡é€»è¾‘ (`services`) å’Œ API æ¥å£ (`api/endpoints`) å¿…é¡»åˆ†ç¦»ã€‚
2.  **èšåˆ**: ä½¿ç”¨ `api_router.py` ä½œä¸º `main.py` å’Œå…·ä½“ `endpoints` ä¹‹é—´çš„æ¡¥æ¢ã€‚
3.  **æ¨¡å‹èŒè´£åˆ†ç¦»ä¸ç»„ç»‡**:
    *   **å…±äº«æ¨¡å‹ (`shared/`)**: 
        *   **æŒ‰ç«¯ç‚¹æ‹†åˆ†**: æ¯ä¸ª API ç«¯ç‚¹å¯¹åº”ä¸€ä¸ªæ¨¡å‹æ–‡ä»¶ (`shared/endpoint_name.py`)
        *   **ä»…ç”¨äº API**: ç”¨äºè¯·æ±‚ä½“æ ¡éªŒå’Œå“åº”ä½“å®šä¹‰
        *   **æšä¸¾å®šä¹‰**: è¯·æ±‚ä½“/å“åº”ä½“ä½¿ç”¨çš„æšä¸¾ç±»å‹å¿…é¡»åœ¨å¯¹åº” `shared/` æ–‡ä»¶ä¸­å®šä¹‰
        *   **é€šç”¨æ¨¡å‹**: å¦‚ `MessageResponse`, `ErrorResponse` ä¿ç•™åœ¨ `shared/schemas.py`
    *   **æ•°æ®åº“æ¨¡å‹ (`backend/db_models`)**: ä»…ç”¨äºæ•°æ®åº“äº¤äº’å’Œä¸šåŠ¡é€»è¾‘å®ç°
    *   **API ç«¯ç‚¹**: å¿…é¡»ä½¿ç”¨å…±äº«æ¨¡å‹,**ä¸å¾—**ç›´æ¥ä½¿ç”¨æ•°æ®åº“æ¨¡å‹
4.  **å¯¼å…¥è§„èŒƒ**: API ç«¯ç‚¹ä»å¯¹åº”çš„ `shared/endpoint_name.py` å¯¼å…¥æ¨¡å‹,ä¾‹å¦‚:
    ```python
    # backend/api/endpoints/chat.py
    from shared.chat import ChatSessionCreate, ChatSessionRead, ChatTurnRequest
    
    # backend/api/endpoints/llm_setting.py  
    from shared.llm_setting import LLMConfigCreate, LLMConfigResponse, LLMTestResponse
    ```
5.  **è§„èŒƒ**: æ—¶åˆ»éµå®ˆ `AIç¼–ç¨‹è§„èŒƒ`,ç¡®ä¿ä»£ç è´¨é‡å’Œä¸€è‡´æ€§ã€‚
6.  **æµ‹è¯•**: åˆ†ç¦»åçš„ `services` å±‚æ›´å®¹æ˜“è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚
7.  **ä¾èµ–æ³¨å…¥**: åœ¨ API ç«¯ç‚¹ä¸­ä½¿ç”¨ `Depends` æ¥æ³¨å…¥æœåŠ¡å±‚æ‰€éœ€çš„ä¾èµ–ï¼ˆå¦‚æ•°æ®åº“ Sessionï¼‰,æé«˜ä»£ç çš„å¯æµ‹è¯•æ€§å’Œè§£è€¦æ€§ã€‚
8.  **å“åº”ä½“å®‰å…¨**: 
    *   å“åº”æ¨¡å‹ä¸å¾—åŒ…å«æ•æ„Ÿå­—æ®µï¼ˆå¯†ç ã€å¯†é’¥ç­‰ï¼‰
    *   ä½¿ç”¨ `Config.from_attributes = True` æ”¯æŒä» ORM æ¨¡å‹è½¬æ¢
    *   æ˜ç¡®å®šä¹‰è¿”å›å­—æ®µ,é¿å…æ„å¤–æš´éœ²æ•°æ®
9.  **ä¸šåŠ¡ç­›é€‰ä½ç½®å»ºè®®**: ä¸šåŠ¡ç­›é€‰ã€å­—æ®µè£å‰ªã€æƒé™/å¯è§æ€§ç­‰è§„åˆ™åº”æ”¾åœ¨ service å±‚ï¼Œä¾¿äºå¤ç”¨ä¸é›†ä¸­ç®¡ç†ï¼ŒAPI å±‚ä¿æŒè–„ã€è´Ÿè´£è·¯ç”±ä¸è¾“å…¥æ ¡éªŒå³å¯ï¼›è‹¥æ”¾åœ¨ API å±‚ä¼šå¯¼è‡´å¤šå¤„é‡å¤å’Œä¸šåŠ¡åˆ†æ•£ï¼Œä¸åˆ©äºç»´æŠ¤ã€‚
10. **æ–‡ä»¶å‘½åè§„èŒƒ**: æ–‡ä»¶åéœ€è¿½åŠ åŠŸèƒ½æ€§åç¼€ï¼Œä¾‹å¦‚ï¼š`_api`ã€`_schemas`ã€`_service`ã€`_handler`ã€`_ui`ï¼Œä¾¿äºè¯†åˆ«èŒè´£ä¸å±‚æ¬¡ã€‚

**ğŸ”„ å‰åç«¯éªŒè¯æµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ (Gradio)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. ç”¨æˆ·æäº¤è¡¨å•
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP Request         â”‚
â”‚ POST /api/users      â”‚
â”‚ Body: {              â”‚
â”‚   "username": "...", â”‚
â”‚   "email": "...",    â”‚
â”‚   "password": "..."  â”‚
â”‚ }                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. è¯·æ±‚å‘é€åˆ°åç«¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FastAPI Endpoint     â”‚
â”‚ @router.post("")     â”‚
â”‚ def create_user(     â”‚
â”‚   user_data:         â”‚
â”‚     UserCreate       â”‚ â† ä½¿ç”¨ shared/user.py ä¸­çš„æ¨¡å‹
â”‚ )                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. Pydantic è‡ªåŠ¨æ ¡éªŒ
       â”‚    - ç±»å‹æ£€æŸ¥
       â”‚    - å­—æ®µéªŒè¯ (min_length, regex ç­‰)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service Layer        â”‚
â”‚ UserService.create() â”‚ â† ä½¿ç”¨ db_models ä¸­çš„æ•°æ®åº“æ¨¡å‹
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. ä¿å­˜åˆ°æ•°æ®åº“
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database (SQLite)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 5. è¿”å›æ•°æ®åº“æ¨¡å‹å®ä¾‹
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FastAPI Endpoint     â”‚
â”‚ return user_db_model â”‚ â† FastAPI è‡ªåŠ¨è½¬æ¢ä¸º UserResponse
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. åºåˆ—åŒ–ä¸º JSON (ä½¿ç”¨ response_model)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP Response        â”‚
â”‚ Status: 200          â”‚
â”‚ Body: {              â”‚
â”‚   "id": 1,           â”‚
â”‚   "username": "...", â”‚
â”‚   "email": "...",    â”‚
â”‚   "created_at": "..."â”‚
â”‚ }                    â”‚ â† ä¸åŒ…å« password å­—æ®µ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 7. å“åº”è¿”å›å‰ç«¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ (Gradio)â”‚ â† æ›´æ–° UI æ˜¾ç¤ºç»“æœ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éªŒè¯å±‚æ¬¡è¯´æ˜**:
1. **å‰ç«¯éªŒè¯**: Gradio ç»„ä»¶çš„åŸºç¡€éªŒè¯ (å¯é€‰,ç”¨æˆ·ä½“éªŒä¼˜åŒ–)
2. **Pydantic éªŒè¯**: FastAPI ä½¿ç”¨ `shared/` ä¸­çš„æ¨¡å‹è‡ªåŠ¨æ ¡éªŒè¯·æ±‚ä½“
3. **ä¸šåŠ¡é€»è¾‘éªŒè¯**: Service å±‚çš„ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
4. **æ•°æ®åº“çº¦æŸ**: æ•°æ®åº“å±‚çš„å®Œæ•´æ€§çº¦æŸ

**é”™è¯¯å¤„ç†é“¾**:
```
å‰ç«¯è¡¨å• â†’ Pydantic æ ¡éªŒå¤±è´¥ â†’ 422 Unprocessable Entity
          â†’ ä¸šåŠ¡é€»è¾‘å¤±è´¥ â†’ 400 Bad Request (HTTPException)
          â†’ æ•°æ®åº“é”™è¯¯ â†’ 500 Internal Server Error
```