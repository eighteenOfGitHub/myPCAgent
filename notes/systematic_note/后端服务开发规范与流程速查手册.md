
### **后端服务开发规范与流程速查手册**

#### **核心思想**

*   **分层架构**: 将代码逻辑清晰地分离到不同的层中，实现关注点分离。
*   **后端函数实现与 API 分离**: 业务逻辑与接口定义解耦，提高可维护性、可测试性和可重用性。
*   **遵循项目规范**: 严格遵守 `AI编程规范.md` 中的 Python 编写标准。

---

#### **项目结构 (修正版)**

```
.
├── backend/
│   ├── core/                 # 核心业务逻辑层 (与框架无关)
│   │   ├── __init__.py
│   │   ├── services/         # 业务服务层 (核心逻辑实现)
│   │   │   ├── __init__.py
│   │   │   └── service_name.py # 例如: greeting_service.py, user_service.py
│   │   ├── tools/            # LangGraph Tool 逻辑
│   │   └── other_core_modules.py
│   ├── api/
│   │   └── v1/               # API v1 版本
│   │       ├── __init__.py
│   │       ├── api_router.py # v1 API 的主路由器 (聚合各模块路由)
│   │       └── endpoints/    # API 端点定义层 (与框架耦合)
│   │           ├── __init__.py
│   │           └── module_name.py # 例如: greeting.py, user.py
│   ├── config/
│   │   └── settings.py       # 应用配置管理
│   ├── logs/                 # 日志文件 (由 settings 配置)
│   └── main.py               # FastAPI 应用入口
├── shared/                   # 前后端共享模块
│   └── v1/
│       └── schemas.py        # 共享的 Pydantic 模型 (请求/响应/数据库模型)
├── frontend/
│   └── app.py
└── main.py                   # 项目主启动文件
```

---

#### **开发流程**

1.  **设计业务逻辑 (Service Layer)**:
    *   **位置**: `backend/core/services/service_name.py`
    *   **原则**:
        *   专注于业务逻辑本身，与 FastAPI 框架无关。
        *   函数参数和返回值使用简单的 Python 类型或 Pydantic 模型实例。
        *   使用 `async def` 定义异步函数。
        *   编写清晰的函数文档字符串 (Docstring)。
        *   遵循 `AI编程规范` (命名、类型提示、错误处理等)。
    *   **示例**:
        ```python
        # backend/core/services/greeting_service.py
        import asyncio
        from typing import Dict, Any

        async def generate_greeting(name: str = "World") -> Dict[str, Any]:
            """
            生成问候语。

            Args:
                name (str): 要问候的名字。

            Returns:
                Dict[str, Any]: 包含问候语的字典。
            """
            await asyncio.sleep(0.1) # 模拟异步操作
            greeting_message = f"Hello, {name}!"
            return {"message": greeting_message}
        ```

2.  **定义共享模型 (Schemas)**:
    *   **位置**: `shared/v1/schemas.py`
    *   **原则**:
        *   使用 `pydantic.BaseModel` 定义请求体、响应体和数据库模型。
        *   为 API 端点提供数据校验和序列化。
    *   **示例**:
        ```python
        # shared/v1/schemas.py
        from pydantic import BaseModel

        class GreetingResponse(BaseModel):
            message: str
        ```

3.  **创建 API 端点 (Endpoint Layer)**:
    *   **位置**: `backend/api/v1/endpoints/module_name.py`
    *   **原则**:
        *   使用 `fastapi.APIRouter` 定义路由。
        *   负责数据校验、调用服务层函数、处理异常、返回响应。
        *   使用 `response_model` 指定响应格式。
        *   遵循 `AI编程规范`。
    *   **示例**:
        ```python
        # backend/api/v1/endpoints/greeting.py
        from fastapi import APIRouter, HTTPException
        from backend.core.services.greeting_service import generate_greeting
        from shared.v1.schemas import GreetingResponse # 注意导入路径

        router = APIRouter(prefix="/greeting", tags=["Greeting"])

        @router.get("/hello", response_model=GreetingResponse)
        async def say_hello(name: str = "World"):
            """
            生成问候语 API 端点。
            """
            try:
                result = await generate_greeting(name)
                return result
            except Exception as e:
                raise HTTPException(status_code=500, detail=str(e))
        ```

4.  **聚合 API 路由 (API Router)**:
    *   **位置**: `backend/api/v1/api_router.py`
    *   **原则**:
        *   创建主 `APIRouter` 实例 (通常不设置 `prefix`)。
        *   使用 `include_router` 将各功能模块的路由器聚合进来。
    *   **示例**:
        ```python
        # backend/api/v1/api_router.py
        from fastapi import APIRouter
        from backend.api.v1.endpoints import greeting # 导入端点路由器

        api_router = APIRouter(tags=["v1"])
        api_router.include_router(greeting.router) # 包含端点路由
        ```

5.  **启动 FastAPI 应用 (Main)**:
    *   **位置**: `backend/main.py`
    *   **原则**:
        *   创建 `FastAPI` 实例。
        *   添加中间件（如 `CORSMiddleware`）。
        *   使用 `app.include_router(api_router, prefix="/api/v1")` 加载 API 路由。
        *   通过 `uvicorn` 启动应用。
    *   **示例**:
        ```python
        # backend/main.py
        from fastapi import FastAPI
        from fastapi.middleware.cors import CORSMiddleware
        from backend.api.v1.api_router import api_router
        from backend.config.settings import settings

        app = FastAPI(title="My App API")

        app.add_middleware(
            CORSMiddleware,
            allow_origins=settings.ALLOWED_ORIGINS,
            allow_credentials=True,
            allow_methods=["*"],
            allow_headers=["*"],
        )

        app.include_router(api_router, prefix="/api/v1") # 加载路由

        if __name__ == "__main__":
            import uvicorn
            uvicorn.run(app, host="127.0.0.1", port=8000)
        ```

---

#### **关键要点**

*   **分离**: **业务逻辑** (`core/services`) 和 **API 接口** (`api/v1/endpoints`) 必须分离。
*   **聚合**: 使用 `api_router.py` 作为 `main.py` 和具体 `endpoints` 之间的桥梁。
*   **模型**: 共享模型 (`shared/schemas.py`) 是前后端和 API 内部交互的契约，位于项目根目录与 `backend` 同级。
*   **规范**: 时刻遵守 `AI编程规范`，确保代码质量和一致性。
*   **测试**: 分离后的 `core/services` 层更容易进行单元测试。